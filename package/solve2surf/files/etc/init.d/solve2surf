#!/bin/sh /etc/rc.common

START=95
USE_PROCD=1

# Rea d UCI config
get_config() {
    config_get "$1" "main" "$2" "$3"
}

configure_opennds() {
    local enabled fas_key interface

    # Check is opennds is installed
    if ! uci -q get opennds.@opennds[0] > /dev/null; then
		# Log to system log for debugging
		logger -t solve2surf "Error: opennds config section not found. Is opennds installed?"
		return 1
	fi

    config_load solve2surf
    get_config enabled "enabled" "0"
    get_config fas_key "fas_key" ""
    get_config interface "interface" "lan"

    if [ "$enabled" -eq 1 ]; then
        # Configure OpenNDS via UCI
		uci set opennds.@opennds[0].gatewayinterface="$interface"
		uci set opennds.@opennds[0].fashost='127.0.0.1'
		uci set opennds.@opennds[0].fasport='80'
		uci set opennds.@opennds[0].faspath='/cgi-bin/fas.sh'
		uci set opennds.@opennds[0].fas_secure_enabled='1'
		uci set opennds.@opennds[0].faskey="$fas_key"
		uci commit opennds

		/etc/init.d/opennds enabled && /etc/init.d/opennds reload
    fi
}

start_service() {
    config_load solve2surf
	local enabled
	get_config enabled "enabled" "0"
	[ "$enabled" -eq 1 ] || return 0
	# Coordinate with OpenNDS
	configure_opennds
	# Setup the Cron job for the problem sync
	# We'll just append it to the crontab if it's not there
	touch /etc/crontabs/root
	if ! grep -q "solve2surf-sync.sh" /etc/crontabs/root 2>/dev/null; then
		echo "0 * * * * /usr/bin/solve2surf-sync.sh" >> /etc/crontabs/root
		/etc/init.d/cron restart
	fi
    # Add dummy problems
    [ -f "$PROBLEMS_FILE" ] || cp /etc/solve2surf/sample_problems.json "$PROBLEMS_FILE"

    # setup uhttpd for cgi execution
    if ! uci -q get uhttpd.main.cgi_prefix 2>/dev/null | grep -q "/cgi-bin"; then
    uci -q set uhttpd.main.cgi_prefix='/cgi-bin'
    uci commit uhttpd
    /etc/init.d/uhttpd reload
fi
	# Handle any background processes if needed (Procd)
	procd_open_instance
	procd_set_param command /bin/true # No persistent binary needed for now
	procd_close_instance
}

stop_service() {
	# Clean up logic: We should probably disable FAS in OpenNDS if we stop.
	if uci -q get opennds.@opennds[0] > /dev/null 2>&1; then
		uci -q set opennds.@opennds[0].fas_secure_enabled='0'
		uci commit opennds
		[ -x /etc/init.d/opennds ] && /etc/init.d/opennds reload
	fi

	# Remove cron job
	[ -f /etc/crontabs/root ] && sed -i '/solve2surf-sync.sh/d' /etc/crontabs/root
	/etc/init.d/cron restart
}
service_triggers() {
	# Reload if our own config file changes
	procd_add_reload_trigger "solve2surf"
}